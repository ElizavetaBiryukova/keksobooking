(()=>{"use strict";const e=(e,t,o,r)=>{if(e>10&&1===Math.round(e%100/10))return r;switch(e%10){case 1:return t;case 2:case 3:case 4:return o}return r},t={flat:{ru:"Квартира",minPrice:1e3},bungalow:{ru:"Бунгало",minPrice:0},house:{ru:"Дом",minPrice:5e3},palace:{ru:"Дворец",minPrice:1e4}},o=document.querySelector("#card").content.querySelector(".popup"),r={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},n=document.querySelector(".map__filters"),c=document.querySelector(".ad-form"),s=document.querySelectorAll("fieldset"),a=n.querySelectorAll("select"),i=document.querySelector("#address"),l=c.querySelector("#type"),d=c.querySelector("#price"),u=c.querySelector("#timein"),p=c.querySelector("#timeout"),m=c.querySelector("#title"),y=c.querySelector("#room_number"),v=c.querySelector("#capacity").querySelectorAll("option"),g=()=>{d.min=t[l.value].minPrice,d.placeholder=t[l.value].minPrice};g(),l.addEventListener("change",g),u.addEventListener("change",(()=>{p.value=u.value})),p.addEventListener("change",(()=>{u.value=p.value}));const h=e=>{e.forEach((e=>{e.disabled=!e.disabled}))};n.classList.add("map__filters--disabled"),c.classList.add("ad-form--disabled"),h(s),h(a),m.addEventListener("input",(()=>{const e=m.value.length;e<30?m.setCustomValidity(`Введите ещё ${30-e} симв.`):e>100?m.setCustomValidity(`Удалите лишние ${e-100} симв.`):m.setCustomValidity(""),m.reportValidity()})),d.addEventListener("input",(()=>{d.value.length>1e6?d.setCustomValidity("Цена должна быть меньше 1000000"):d.setCustomValidity(""),d.reportValidity()}));const f=()=>{const e=y.value;v.forEach((function(t){let o=!(r[e].indexOf(t.value)>=0);t.selected=r[e][0]===t.value,t.disabled=o,t.hidden=o}))};y.addEventListener("change",(()=>{f()})),f();const S={low:{start:0,end:1e4},middle:{start:1e4,end:5e4},high:{start:5e4,end:1/0}},_=Array.from(n.children),q={"housing-type":(e,t)=>t.value===e.offer.type,"housing-price":(e,t)=>e.offer.price>=S[t.value].start&&e.offer.price<S[t.value].end,"housing-rooms":(e,t)=>t.value===e.offer.rooms.toString(),"housing-guests":(e,t)=>t.value===e.offer.guests.toString(),"housing-features":(e,t)=>Array.from(t.querySelectorAll('input[type="checkbox"]:checked')).every((t=>e.offer.features.some((e=>e===t.value))))},E={GET:"https://22.javascript.pages.academy/keksobooking/data",POST:"https://22.javascript.pages.academy/keksobooking"},k=(e,t,o,r)=>{fetch(E[o],{method:o,body:r}).then((e=>e.json())).then((t=>{e(t)})).catch((()=>{t()}))};let b=[];const x=35.62605,C=139.77081,w=L.map("map-canvas").on("load",(()=>{n.classList.remove("map__filters--disabled"),c.classList.remove("ad-form--disabled"),h(s),h(a)})).setView({lat:x,lng:C},10);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(w);const T=L.icon({iconUrl:"./img/main-pin.svg",iconSize:[52,52],iconAnchor:[26,52]}),$=L.marker({lat:x,lng:C},{draggable:!0,icon:T});$.addTo(w),i.value="35.62605, 139.77081",$.on("move",(e=>{i.value=`${e.target.getLatLng().lat.toFixed(5)}, ${e.target.getLatLng().lng.toFixed(5)}`}));const A=L.layerGroup().addTo(w),P=r=>{r.forEach((r=>{const n=r.location.lat,c=r.location.lng,s=L.icon({iconUrl:"./img/pin.svg",iconSize:[52,52],iconAnchor:[26,52]});L.marker({lat:n,lng:c},{icon:s}).addTo(A).bindPopup((({author:{avatar:r},offer:{title:n,address:c,price:s,type:a,rooms:i,guests:l,checkin:d,checkout:u,features:p,photos:m,description:y}})=>{const v=o.cloneNode(!0),g=v.querySelector(".popup__title");n?g.textContent=n:g.remove();const h=v.querySelector(".popup__text--address");c?h.textContent=c:h.remove();const f=v.querySelector(".popup__text--price");s?f.textContent=`${s} ₽/ночь`:f.remove();const L=v.querySelector(".popup__type");a?L.textContent=t[a].ru:L.remove();const S=v.querySelector(".popup__text--capacity");i&&l?S.textContent=`${i} ${e(i,"комната","комнаты","комнат")} для ${l} ${e(l,"гостя","гостей","гостей")}`:S.remove();const _=v.querySelector(".popup__text--time");d&&u?_.textContent=`Заезд после ${d}, выезд до ${u}`:_.remove();const q=v.querySelector(".popup__features");if(p){q.innerHTML="";for(let e=0;e<p.length;e++){const t=document.createElement("li"),o=`popup__feature--${p[e]}`;t.classList.add("popup__feature",o),q.appendChild(t)}}else q.remove();const E=v.querySelector(".popup__description");y?E.textContent=y:E.remove();const k=v.querySelector(".popup__photos");if(m){k.innerHTML="";for(let e=0;e<m.length;e++){const t=o.querySelector(".popup__photo").cloneNode(!0);t.src=m[e],k.appendChild(t)}}else k.remove();const b=v.querySelector(".popup__avatar");return r?b.src=r:b.remove(),v})(r),{keepInView:!0})}))},V=()=>{A.clearLayers(),w.closePopup(),P((e=>{let t,o=[],r=0;for(;r<e.length&&o.length<10;)t=_.every((t=>"any"===t.value||q[t.id](e[r],t))),t&&o.push(e[r]),r++;return o})(b.slice()))};k((e=>{b=e.slice(),P(b.slice(0,10)),n.addEventListener("change",((e,t)=>{let o;return()=>{o&&clearTimeout(o),o=setTimeout(e,undefined)}})(V),500)}),(()=>{(e=>{const t=document.createElement("div");t.style.zIndex="1000",t.style.position="absolute",t.style.left="0",t.style.top="0",t.style.right="0",t.style.padding="25px 3px",t.style.fontSize="35px",t.style.textAlign="center",t.style.backgroundColor="red",t.textContent="Коничева! Не удалось получить данные c сервера. Попробуйте позже.",document.body.append(t),setTimeout((()=>{t.remove()}),6e3)})()}),"GET");const j=["gif","jpg","jpeg","png"],D=document.querySelector(".ad-form-header__input"),M=document.querySelector(".ad-form-header__preview img"),z=document.querySelector(".ad-form__input"),F=document.querySelector(".ad-form__photo"),N=(e,t)=>{const o=e.files[0],r=o.name.toLowerCase();if(j.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{t.src=e.result})),e.readAsDataURL(o)}};D.addEventListener("change",(e=>{N(e.target,M)})),z.addEventListener("change",(e=>{const t=((e,t)=>{e.hasChildNodes()&&(e.innerHTML="");const o=document.createElement("img");return o.style.width="100%",o.style.height="100%",o.style.objectFit="cover",o.alt="Фотография жилья",F.appendChild(o),o})(F);N(e.target,t)}));const H=()=>{M.src="img/muffin-grey.svg",F.innerHTML=""},U="Escape",G=c.querySelector(".ad-form__reset"),O=document.querySelector("#success").content,I=document.querySelector("#error").content,R=document.querySelector("main");G.addEventListener("click",(e=>{e.preventDefault(),c.reset(),P(b),n.reset(),$.setLatLng([x,C]),g(),H()}));const W=e=>{const t=R.querySelector(".success");e.preventDefault(),e.key!==U&&"Esc"!==e.key||t.remove(),document.removeEventListener("keydown",W),document.removeEventListener("click",B)},B=()=>{R.querySelector(".success").remove(),document.removeEventListener("click",B),document.removeEventListener("keydown",W)},J=e=>{const t=R.querySelector(".error");e.preventDefault(),e.key!==U&&"Esc"!==e.key||t.remove(),document.removeEventListener("keydown",J),document.removeEventListener("click",K)},K=()=>{R.querySelector(".error").remove(),document.removeEventListener("click",K),document.removeEventListener("keydown",J)},Q=()=>{(()=>{const e=O.cloneNode(!0);document.addEventListener("keydown",W),document.addEventListener("click",B),R.appendChild(e)})(),c.reset(),P(b),n.reset(),$.setLatLng([x,C]),H(),g()},X=()=>{(()=>{const e=I.cloneNode(!0);document.addEventListener("keydown",J),document.addEventListener("click",K),R.appendChild(e)})()};c.addEventListener("submit",(e=>{e.preventDefault(),k(Q,X,c.method.toUpperCase(),new FormData(c))}))})();
//# sourceMappingURL=main.bundle.js.map